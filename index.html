<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Console | Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #1f1f1f; --panel: #282828; --primary: #00A173; --text: #fff; --border: #333; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Roboto', sans-serif; display: flex; height: 100vh; overflow: hidden; 
        }
        
        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-box {
            background: var(--panel); padding: 40px; border-radius: 12px;
            width: 350px; text-align: center; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* DASHBOARD LAYOUT */
        #dashboard { display: none; width: 100%; height: 100%; }
        .sidebar { width: 250px; background: var(--panel); padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* SIDEBAR ITEMS */
        .brand { font-size: 20px; font-weight: bold; color: var(--primary); margin-bottom: 30px; display: block; }
        .menu-item { 
            padding: 12px 15px; cursor: pointer; color: #ccc; border-radius: 8px; 
            margin-bottom: 5px; font-weight: 500; display:flex; gap:10px; align-items:center; 
            transition: 0.2s;
        }
        .menu-item:hover, .menu-item.active { background: #383838; color: white; }
        .badge { background: #ff4757; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: auto; }

        /* FORMS */
        h1 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; font-size: 24px; }
        input, textarea, select { 
            width: 100%; background: #181818; border: 1px solid var(--border); color: white; 
            padding: 12px; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; 
        }
        label { display: block; color: #bbb; margin-bottom: 5px; font-size: 13px; }
        
        /* BUTTONS */
        .btn { background: var(--primary); color: black; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; transition:0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-small { width: auto; padding: 6px 12px; font-size: 12px; border-radius: 4px; margin-left: 5px; }
        .bg-red { background: #ff4757; color: white; }
        .bg-blue { background: #3498db; color: white; }
        .bg-yellow { background: #ffa502; color: black; }

        /* UPLOAD BOX */
        .file-box { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 15px; background: #222; }
        .preview-img { height: 60px; margin-top: 10px; display: none; object-fit: contain; margin-left: auto; margin-right: auto; }
        .two-col { display: flex; gap: 15px; }

        /* LIST ITEMS */
        .req-card, .game-row { 
            background: var(--panel); padding: 15px; border-radius: 10px; 
            margin-bottom: 10px; display: flex; align-items: center; border: 1px solid var(--border); 
        }
        .req-img, .game-row img { width: 50px; height: 50px; border-radius: 10px; margin-right: 15px; object-fit: cover; background: #000; }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .info-row { margin-bottom: 10px; font-size: 14px; color: #ccc; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .info-label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 2px; }
        .download-link-box { background: #111; padding: 8px; border-radius: 5px; font-family: monospace; color: #aaa; word-break: break-all; display: block; margin-top: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <!-- AUTHENTICATION -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0">Nexus Admin</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Restricted Access</p>
            <input type="email" id="admin-email" placeholder="Admin Email">
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn" onclick="window.adminLogin()">Login</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="sidebar">
            <span class="brand"><i class="fas fa-gamepad"></i> Nexus Console</span>
            
            <div class="menu-item active" onclick="window.showView('publish')">
                <i class="fas fa-upload"></i> Publish / Edit
            </div>
            
            <div class="menu-item" onclick="window.showView('requests')">
                <i class="fas fa-inbox"></i> Requests <span class="badge" id="req-count">0</span>
            </div>
            
            <div class="menu-item" onclick="window.showView('live')">
                <i class="fas fa-check-circle"></i> Live Apps
            </div>

            <div style="margin-top:auto">
                <button class="btn bg-red" onclick="window.adminLogout()">Logout</button>
            </div>
        </div>

        <div class="main">
            
            <!-- 1. PUBLISH FORM -->
            <div id="view-publish">
                <h1 id="form-title">Publish New App</h1>
                <div style="background: var(--panel); padding: 25px; border-radius: 12px; max-width: 700px;">
                    
                    <label>App Name</label>
                    <input type="text" id="name" placeholder="Enter App Name">

                    <div class="two-col">
                        <div style="flex:1"><label>Type</label><select id="appType"><option>Game</option><option>App</option></select></div>
                        <div style="flex:1"><label>Category</label><select id="appCat"><option>Action</option><option>Racing</option><option>RPG</option><option>Tools</option><option>Social</option></select></div>
                    </div>

                    <div class="two-col">
                        <div style="flex:1"><label>Size</label><input type="text" id="appSize" placeholder="1.2 GB"></div>
                        <div style="flex:1"><label>Age Rating</label><input type="text" id="appAge" placeholder="12+"></div>
                    </div>

                    <div class="two-col">
                        <div style="flex:1">
                            <label>Pricing</label>
                            <select id="priceType" onchange="window.togglePrice()">
                                <option value="Free">Free</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <label>Price</label>
                            <input type="text" id="appPrice" placeholder="Rs. 500" disabled style="opacity:0.5">
                        </div>
                    </div>

                    <!-- Hidden Dev Name -->
                    <input type="hidden" id="appDeveloper">

                    <label>App Icon</label>
                    <div class="file-box" onclick="document.getElementById('iconFile').click()">
                        Click to Upload Icon
                        <img id="iconPrev" class="preview-img">
                    </div>
                    <input type="file" id="iconFile" hidden accept="image/*" onchange="window.handleIcon(this)">
                    <input type="hidden" id="iconBase64">

                    <label>Download Link</label>
                    <input type="text" id="link" placeholder="Direct Download URL">

                    <label>Description</label>
                    <textarea id="desc" rows="4" placeholder="App description..."></textarea>

                    <label>Screenshots</label>
                    <div id="sc-container" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;"></div>
                    <button class="btn" style="background:#444; color:white; width:auto; margin-bottom:20px; font-size:12px;" onclick="window.addScField()">+ Add Screenshot</button>

                    <button class="btn" id="btn-submit" onclick="window.publishApp()">PUBLISH APP</button>
                    <button class="btn bg-red" id="btn-cancel" style="display:none; margin-top:10px;" onclick="window.resetForm()">CANCEL EDIT</button>
                </div>
            </div>

            <!-- 2. REQUESTS LIST -->
            <div id="view-requests" style="display:none;">
                <h1>Pending Reviews</h1>
                <div id="list-requests">Loading...</div>
            </div>

            <!-- 3. LIVE APPS LIST -->
            <div id="view-live" style="display:none;">
                <h1>Published Apps</h1>
                <div id="list-live">Loading...</div>
            </div>

        </div>
    </div>

    <!-- REVIEW MODAL -->
    <div id="review-modal" class="modal">
        <div class="modal-content">
            <h3 id="m-title" style="margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">App Review</h3>
            
            <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
                <img id="m-icon" style="width:70px; height:70px; border-radius:12px; object-fit:cover; border:1px solid #444;">
                <div>
                    <div id="m-req-type" style="color:orange; font-size:12px; font-weight:bold; margin-bottom:5px;">REQUEST</div>
                    <div id="m-dev" style="color:white; font-weight:bold; font-size:16px;">Dev Name</div>
                    <div id="m-cat" style="color:#888; font-size:12px;">Category</div>
                </div>
            </div>

            <div class="info-row"><span class="info-label">Price:</span> <span id="m-price"></span></div>
            <div class="info-row"><span class="info-label">Description:</span> <span id="m-desc"></span></div>
            
            <div style="background:#222; padding:15px; border-radius:8px; margin:20px 0; border:1px solid #444;">
                <span class="info-label"><i class="fas fa-link"></i> Submitted Link:</span>
                <span id="m-link-text" class="download-link-box">...</span>
                <button class="btn bg-blue" style="margin-top:10px;" onclick="window.openTestDownload()">
                    <i class="fas fa-download"></i> Test Download
                </button>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" style="background:#00c851; color:white; flex:1;" onclick="window.approveApp()">APPROVE</button>
                <button class="btn bg-red" style="flex:1;" onclick="window.rejectApp()">REJECT</button>
            </div>
            <button class="btn" style="background:transparent; border:1px solid #444; color:#888; margin-top:10px;" onclick="document.getElementById('review-modal').style.display='none'">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, push, update, remove, onValue, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn1FBaxDwbvC28VWXAcq557uCidl-JHy0",
            authDomain: "app-store-6b5d4.firebaseapp.com",
            databaseURL: "https://app-store-6b5d4-default-rtdb.firebaseio.com",
            projectId: "app-store-6b5d4",
            storageBucket: "app-store-6b5d4.firebasestorage.app",
            messagingSenderId: "55022892860",
            appId: "1:55022892860:web:f48865da1539854bf8d039"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentEditId = null; 
        let liveAppsData = {}; 
        let pendingAppsData = {}; 
        let currentReviewId = null;
        let currentAppData = null;

        // AUTH
        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard').style.display='flex';
                loadData();
            } else {
                document.getElementById('login-screen').style.display='flex';
                document.getElementById('dashboard').style.display='none';
            }
        });
        window.adminLogin = () => {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
        };
        window.adminLogout = () => signOut(auth);

        // NAVIGATION
        window.showView = (id) => {
            ['publish','requests','live'].forEach(v => document.getElementById('view-'+v).style.display='none');
            document.getElementById('view-'+id).style.display='block';
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        // FORM LOGIC
        const compress = (f) => new Promise(r => { const rd=new FileReader(); rd.readAsDataURL(f); rd.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'),s=500/i.width; c.width=500; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.7))}}});
        
        window.handleIcon = async (i) => { if(i.files[0]){const b=await compress(i.files[0]);document.getElementById('iconBase64').value=b;document.getElementById('iconPrev').src=b;document.getElementById('iconPrev').style.display='block';}};
        window.togglePrice = () => { const t=document.getElementById('priceType').value; const i=document.getElementById('appPrice'); if(t==='Paid'){i.disabled=false;i.style.opacity=1}else{i.disabled=true;i.style.opacity=0.5;i.value=''}};
        
        window.addScField = () => { 
            const d=document.createElement('div'); 
            d.innerHTML=`<input type="file" class="sc-file" accept="image/*" onchange="window.handleSc(this)" style="width:100px; font-size:10px;">`; 
            document.getElementById('sc-container').appendChild(d); 
        };
        window.handleSc = async (i) => { if(i.files[0]){const b=await compress(i.files[0]);i.setAttribute('data-b64', b); i.style.border="1px solid #00d4ff";}};

        // PUBLISH
        window.publishApp = () => {
            const btn = document.getElementById('btn-submit');
            btn.innerText = "Processing...";
            
            const data = {
                name: document.getElementById('name').value,
                type: document.getElementById('appType').value,
                category: document.getElementById('appCat').value,
                size: document.getElementById('appSize').value,
                age: document.getElementById('appAge').value,
                priceType: document.getElementById('priceType').value,
                price: document.getElementById('appPrice').value || "Free",
                logo: document.getElementById('iconBase64').value,
                download: document.getElementById('link').value,
                desc: document.getElementById('desc').value,
                // Default to Admin if not set
                developer: document.getElementById('appDeveloper').value || "Nexus Official",
                timestamp: Date.now(),
                status: "Live"
            };

            const screenshots = [];
            document.querySelectorAll('.sc-file').forEach(i => { const v=i.getAttribute('data-b64'); if(v) screenshots.push(v); });
            if(screenshots.length > 0) data.screenshots = screenshots;
            
            // If editing live app and no new screenshots, keep old ones
            if(currentEditId && screenshots.length===0 && liveAppsData[currentEditId].screenshots) {
                data.screenshots = liveAppsData[currentEditId].screenshots;
            }

            if(!data.name || !data.download) { btn.innerText = "PUBLISH APP"; return alert("Missing fields"); }

            if(currentEditId) {
                update(ref(db, 'games/'+currentEditId), data).then(() => { alert("Updated!"); window.resetForm(); });
            } else {
                data.downloadCount = 0;
                push(ref(db, 'games'), data).then(() => { alert("Published!"); window.resetForm(); });
            }
        };

        window.editLiveApp = (id) => {
            currentEditId = id; const app = liveAppsData[id];
            window.showView('publish');
            
            document.getElementById('form-title').innerText = "Edit: " + app.name;
            document.getElementById('btn-submit').innerText = "UPDATE APP";
            document.getElementById('btn-cancel').style.display = "block";
            
            document.getElementById('name').value = app.name;
            document.getElementById('appType').value = app.type||'Game';
            document.getElementById('appCat').value = app.category||'Action';
            document.getElementById('appSize').value = app.size||'';
            document.getElementById('appAge').value = app.age||'';
            document.getElementById('priceType').value = app.priceType||'Free';
            document.getElementById('appPrice').value = app.price||'';
            window.togglePrice();
            
            document.getElementById('appDeveloper').value = app.developer;
            document.getElementById('link').value = app.download;
            document.getElementById('desc').value = app.desc;
            document.getElementById('iconBase64').value = app.logo;
            document.getElementById('iconPrev').src = app.logo;
            document.getElementById('iconPrev').style.display = 'block';
        };

        window.resetForm = () => {
            currentEditId = null;
            document.querySelectorAll('input, textarea').forEach(i=>i.value="");
            document.getElementById('iconPrev').style.display='none';
            document.getElementById('sc-container').innerHTML="";
            document.getElementById('form-title').innerText = "Publish New App";
            document.getElementById('btn-submit').innerText = "PUBLISH APP";
            document.getElementById('btn-cancel').style.display = "none";
            document.getElementById('appDeveloper').value = ""; 
        };

        // LOAD DATA
        function loadData() {
            onValue(ref(db, 'games'), s => {
                liveAppsData = s.val() || {};
                const list = document.getElementById('list-live'); list.innerHTML="";
                if(liveAppsData) Object.entries(liveAppsData).reverse().forEach(([k, v]) => {
                    list.innerHTML += `<div class="game-row"><img src="${v.logo}"><div style="flex:1"><b>${v.name}</b><br><small style="color:#00A173">${v.developer || 'Nexus'}</small></div><button class="btn btn-small bg-yellow" onclick="window.editLiveApp('${k}')">Edit</button><button class="btn btn-small bg-red" onclick="window.deleteLive('${k}')">Del</button></div>`;
                });
            });

            onValue(ref(db, 'pending_apps'), s => {
                const d = s.val(); pendingAppsData = d || {};
                const list = document.getElementById('list-requests'); list.innerHTML="";
                let count = 0;
                if(d) Object.entries(d).forEach(([k, v]) => {
                    if(v.status !== 'Rejected') {
                        count++;
                        const badge = v.requestType === "Update" ? '<span style="background:orange;color:black;padding:2px 5px;border-radius:4px;font-size:10px;">UPD</span>' : '<span style="background:lime;color:black;padding:2px 5px;border-radius:4px;font-size:10px;">NEW</span>';
                        list.innerHTML += `<div class="req-card"><img src="${v.logo}" class="req-img"><div class="req-info"><b>${v.name}</b> ${badge}<br><small>Dev: ${v.developer}</small></div><button class="btn btn-small bg-blue" onclick="window.reviewReq('${k}')">Review</button></div>`;
                    }
                });
                document.getElementById('req-count').innerText = count;
            });
        }

        // REVIEW
        window.reviewReq = (id) => {
            currentReviewId = id; currentAppData = pendingAppsData[id];
            
            document.getElementById('m-title').innerText = currentAppData.name;
            document.getElementById('m-icon').src = currentAppData.logo;
            document.getElementById('m-req-type').innerText = currentAppData.requestType || "New";
            document.getElementById('m-dev').innerText = currentAppData.developer;
            document.getElementById('m-cat').innerText = currentAppData.category;
            document.getElementById('m-price').innerText = currentAppData.priceType === 'Paid' ? currentAppData.price : 'Free';
            document.getElementById('m-desc').innerText = currentAppData.desc;
            
            const linkText = document.getElementById('m-link-text');
            linkText.innerText = currentAppData.download;
            // Store link in a way we can open it
            linkText.dataset.url = currentAppData.download;
            
            document.getElementById('review-modal').style.display = 'flex';
        };

        window.openTestDownload = () => {
            const url = document.getElementById('m-link-text').dataset.url;
            window.open(url, '_blank');
        };

        window.approveApp = () => {
            if(!currentReviewId) return;
            const liveData = { ...currentAppData, status: "Live" };
            delete liveData.originalId; delete liveData.requestType;
            if(!liveData.downloadCount) liveData.downloadCount = 0;

            if (currentAppData.originalId) { // Update existing
                update(ref(db, 'games/' + currentAppData.originalId), liveData).then(() => {
                    remove(ref(db, 'pending_apps/' + currentReviewId));
                    alert("Update Approved!");
                    document.getElementById('review-modal').style.display = 'none';
                });
            } else { // New app
                push(ref(db, 'games'), liveData).then(() => {
                    remove(ref(db, 'pending_apps/' + currentReviewId));
                    alert("App Approved!");
                    document.getElementById('review-modal').style.display = 'none';
                });
            }
        };

        window.rejectApp = () => {
            if(confirm("Reject submission?")) {
                update(ref(db, 'pending_apps/' + currentReviewId), { status: 'Rejected' }).then(() => {
                    document.getElementById('review-modal').style.display = 'none';
                    alert("Rejected");
                });
            }
        };

        window.deleteLive = (id) => { if(confirm("Delete live app?")) remove(ref(db, 'games/'+id)); };

    </script>
</body>
</html>