<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Admin | Manage Apps</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-dark: #0f1014;
            --bg-panel: #1b1e26;
            --primary: #00d4ff;
            --primary-dark: #009ec4;
            --danger: #ff4757;
            --warning: #ffa502;
            --text-main: #fff;
            --text-muted: #8898aa;
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; outline: none; }
        body { margin: 0; background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* --- LOGIN --- */
        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: radial-gradient(circle at top right, #003b55 0%, #0f1014 60%); z-index: 9999; position: absolute; width: 100%; top: 0; left: 0; }
        .login-box { background: rgba(27, 30, 38, 0.9); padding: 40px; border-radius: 12px; width: 350px; border: 1px solid var(--border); text-align: center; backdrop-filter: blur(10px); }
        .login-box h2 { margin-bottom: 20px; color: var(--primary); }

        /* --- DASHBOARD --- */
        #dashboard { display: none; height: 100vh; display: flex; }
        
        .sidebar { width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .brand { font-size: 22px; font-weight: 700; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .menu-item.active, .menu-item:hover { background: rgba(0, 212, 255, 0.1); color: var(--primary); }
        .logout-btn { margin-top: auto; color: var(--danger); }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-color: var(--bg-dark); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* FORM STYLES */
        .editor-container { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 40px; }
        .card-panel { background: var(--bg-panel); padding: 25px; border-radius: 12px; border: 1px solid var(--border); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 8px; text-transform: uppercase; }
        
        input, textarea { width: 100%; background: #0f1014; border: 1px solid var(--border); padding: 12px 15px; color: #fff; border-radius: 6px; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* --- DYNAMIC SCREENSHOTS STYLES --- */
        .screenshot-wrapper { display: flex; flex-direction: column; gap: 10px; }
        .sc-row { display: flex; gap: 10px; }
        .btn-plus { 
            background: #222; border: 1px solid var(--primary); color: var(--primary); 
            padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 10px;
            font-weight: bold; transition: 0.2s;
        }
        .btn-plus:hover { background: var(--primary); color: #000; }
        .btn-remove-sc { background: #333; color: var(--danger); border: 1px solid #444; width: 45px; border-radius: 6px; cursor: pointer; }

        /* BUTTONS */
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-primary:hover { background: var(--primary-dark); }
        .edit-controls { display: none; gap: 10px; }
        .btn-update { flex: 1; background: var(--warning); color: #000; padding: 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-cancel { width: 100px; background: #333; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; }

        /* PREVIEW & LIST */
        .preview-area { position: sticky; top: 20px; }
        .preview-card { background-color: #1b1e26; border-radius: 12px; overflow: hidden; width: 100%; max-width: 300px; margin: 0 auto; border: 1px solid rgba(255,255,255,0.1); }
        .preview-img-wrapper { width: 100%; padding-top: 56.25%; position: relative; background: #252830; }
        .preview-img-wrapper img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .preview-content { padding: 15px; }
        
        .manage-section { border-top: 1px solid var(--border); padding-top: 20px; }
        .manage-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-box { position: relative; width: 250px; }
        .search-box input { padding: 8px 15px 8px 35px; border-radius: 20px; font-size: 13px; background: #222; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }
        
        .app-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .app-info { display: flex; align-items: center; gap: 15px; }
        .app-info img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .action-btns { display: flex; gap: 10px; }
        .btn-icon { width: 35px; height: 35px; border-radius: 5px; border: none; cursor: pointer; color: white; display:flex; align-items:center; justify-content:center;}
        .btn-edit { background: rgba(255, 165, 2, 0.2); color: var(--warning); }
        .btn-delete { background: rgba(255, 71, 87, 0.2); color: var(--danger); }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; right: 30px; bottom: 30px; border-left: 5px solid var(--primary); transform: translateY(100px); transition: transform 0.3s; }
        #toast.show { visibility: visible; transform: translateY(0); }
    </style>
</head>
<body>

    <div id="toast">Notification</div>

    <div id="login-screen">
        <div class="login-box">
            <h2>ADMIN LOGIN</h2>
            <div class="form-group"><input type="email" id="email" placeholder="Email"></div>
            <div class="form-group"><input type="password" id="password" placeholder="Password"></div>
            <button class="btn-primary" onclick="login()">ENTER PANEL</button>
        </div>
    </div>

    <div id="dashboard">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-shield-alt"></i> ADMIN PANEL</div>
            <div class="menu-item active"><i class="fas fa-gamepad"></i> Manage Apps</div>
            <div class="menu-item logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>App Management</h1>
                <div class="user-info">Admin Mode</div>
            </div>

            <div class="editor-container">
                <div class="card-panel">
                    <h3 id="form-title" style="margin-top:0; color:var(--primary);">Add New App</h3>
                    
                    <div class="form-group">
                        <label>App Name</label>
                        <input type="text" id="appName" placeholder="e.g. Minecraft" oninput="updatePreview()">
                    </div>

                    <div class="row-2">
                        <div class="form-group">
                            <label>Logo URL</label>
                            <input type="text" id="appLogo" placeholder="https://..." oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Download Link</label>
                            <input type="text" id="appDownload" placeholder="Drive / MediaFire Link">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="appDesc" rows="3" placeholder="Description..."></textarea>
                    </div>

                    <!-- UNLIMITED SCREENSHOTS SECTION -->
                    <div class="form-group">
                        <label>Screenshots URLs</label>
                        <div id="screenshots-container" class="screenshot-wrapper">
                            <!-- 4 Default Inputs will be generated here by JS -->
                        </div>
                        
                        <!-- THE PLUS BUTTON -->
                        <button class="btn-plus" onclick="addOneScreenshotInput()">
                            <i class="fas fa-plus"></i> ADD MORE SCREENSHOTS
                        </button>
                    </div>

                    <button id="btn-publish" class="btn-primary" onclick="saveGame()">PUBLISH APP</button>
                    
                    <div id="edit-controls" class="edit-controls">
                        <button class="btn-update" onclick="saveGame()">UPDATE APP</button>
                        <button class="btn-cancel" onclick="cancelEdit()">CANCEL</button>
                    </div>
                </div>

                <div class="preview-area">
                    <div style="text-align:center; color:#888; margin-bottom:10px; font-size:12px;">LIVE PREVIEW</div>
                    <div class="preview-card">
                        <div class="preview-img-wrapper">
                            <img id="prev-img" src="https://via.placeholder.com/300?text=Logo">
                        </div>
                        <div class="preview-content">
                            <h3 id="prev-title">App Name</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="manage-section">
                <div class="manage-header-row">
                    <div class="manage-title">Published Apps</div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchApps" placeholder="Search..." onkeyup="filterApps()">
                    </div>
                </div>
                <div id="apps-list">
                    <div style="text-align:center; color:#666;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn1FBaxDwbvC28VWXAcq557uCidl-JHy0",
            authDomain: "app-store-6b5d4.firebaseapp.com",
            databaseURL: "https://app-store-6b5d4-default-rtdb.firebaseio.com",
            projectId: "app-store-6b5d4",
            storageBucket: "app-store-6b5d4.firebasestorage.app",
            messagingSenderId: "55022892860",
            appId: "1:55022892860:web:f48865da1539854bf8d039"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentEditId = null;
        let allGamesData = {};

        // AUTH
        window.login = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => showToast(err.message, "error"));
        };
        window.logout = () => signOut(auth);
        onAuthStateChanged(auth, user => {
            document.getElementById('login-screen').style.display = user ? 'none' : 'flex';
            document.getElementById('dashboard').style.display = user ? 'flex' : 'none';
            if(user) resetForm(); // Initialize form with 4 inputs on login
        });

        // --- DYNAMIC SCREENSHOT LOGIC ---
        function generateScreenshotInputs(existingData = []) {
            const container = document.getElementById('screenshots-container');
            container.innerHTML = ""; // Clear
            
            // Determine how many inputs to show (At least 4)
            let count = Math.max(4, existingData.length);
            
            for (let i = 0; i < count; i++) {
                const val = existingData[i] || "";
                const placeholder = `Screenshot ${i + 1} URL`;
                
                const div = document.createElement('div');
                div.className = 'sc-row';
                div.innerHTML = `
                    <input type="text" class="sc-input" placeholder="${placeholder}" value="${val}">
                    ${i >= 4 ? `<button class="btn-remove-sc" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>` : ''}
                `;
                container.appendChild(div);
            }
        }

        // The "+" button functionality
        window.addOneScreenshotInput = () => {
            const container = document.getElementById('screenshots-container');
            const count = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'sc-row';
            div.innerHTML = `
                <input type="text" class="sc-input" placeholder="Screenshot ${count} URL">
                <button class="btn-remove-sc" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
        }

        // SAVE
        window.saveGame = () => {
            // Collect Screenshots into Array
            const inputs = document.querySelectorAll('.sc-input');
            const ssArray = [];
            inputs.forEach(inp => {
                if(inp.value.trim() !== "") ssArray.push(inp.value.trim());
            });

            const gameData = {
                name: document.getElementById('appName').value,
                logo: document.getElementById('appLogo').value,
                desc: document.getElementById('appDesc').value,
                download: document.getElementById('appDownload').value,
                screenshots: ssArray, // Saving as array
                timestamp: Date.now()
            };

            if(!gameData.name || !gameData.download) {
                showToast("Name and Link required!", "error");
                return;
            }

            if (currentEditId) {
                update(ref(db, 'games/' + currentEditId), gameData)
                    .then(() => { showToast("Updated Successfully!", "success"); cancelEdit(); });
            } else {
                push(ref(db, 'games'), gameData)
                    .then(() => { showToast("Published Successfully!", "success"); resetForm(); });
            }
        };

        // RENDER LIST
        onValue(ref(db, 'games'), (snapshot) => {
            const data = snapshot.val();
            allGamesData = data || {};
            const list = document.getElementById('apps-list');
            list.innerHTML = "";
            if (data) {
                Object.entries(data).reverse().forEach(([key, game]) => {
                    const item = document.createElement('div');
                    item.className = 'app-item';
                    item.setAttribute('data-name', game.name.toLowerCase());
                    item.innerHTML = `
                        <div class="app-info">
                            <img src="${game.logo}" onerror="this.src='https://via.placeholder.com/50'">
                            <div style="font-weight:bold;">${game.name}</div>
                        </div>
                        <div class="action-btns">
                            <button class="btn-icon btn-edit" onclick="editGame('${key}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="deleteGame('${key}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:#666;'>No apps found.</div>";
            }
        });

        // EDIT
        window.editGame = (key) => {
            currentEditId = key;
            const game = allGamesData[key];

            document.getElementById('appName').value = game.name;
            document.getElementById('appLogo').value = game.logo;
            document.getElementById('appDownload').value = game.download;
            document.getElementById('appDesc').value = game.desc;
            
            // Handle Screenshots (Check if array or old format)
            let existingSS = [];
            if(game.screenshots && Array.isArray(game.screenshots)) {
                existingSS = game.screenshots;
            } else {
                if(game.sc1) existingSS.push(game.sc1);
                if(game.sc2) existingSS.push(game.sc2);
                if(game.sc3) existingSS.push(game.sc3);
                if(game.sc4) existingSS.push(game.sc4);
            }
            generateScreenshotInputs(existingSS);
            updatePreview();

            document.getElementById('btn-publish').style.display = 'none';
            document.getElementById('edit-controls').style.display = 'flex';
            document.getElementById('form-title').innerText = "Edit: " + game.name;
            document.querySelector('.main-content').scrollTop = 0;
        };

        window.cancelEdit = () => {
            currentEditId = null;
            resetForm();
            document.getElementById('btn-publish').style.display = 'block';
            document.getElementById('edit-controls').style.display = 'none';
            document.getElementById('form-title').innerText = "Add New App";
        };

        window.deleteGame = (key) => {
            if(confirm("Delete this app?")) remove(ref(db, 'games/' + key));
        };

        window.filterApps = () => {
            const query = document.getElementById('searchApps').value.toLowerCase();
            document.querySelectorAll('.app-item').forEach(item => {
                item.style.display = item.getAttribute('data-name').includes(query) ? 'flex' : 'none';
            });
        };

        window.updatePreview = () => {
            const title = document.getElementById('appName').value;
            const logo = document.getElementById('appLogo').value;
            document.getElementById('prev-title').innerText = title || "App Name";
            if(logo) document.getElementById('prev-img').src = logo;
        };

        function resetForm() {
            document.querySelectorAll('input, textarea').forEach(i => i.value = '');
            generateScreenshotInputs([]); // Resets to 4 empty inputs
            updatePreview();
        }

        function showToast(msg, type) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.className = "show " + type;
            setTimeout(() => { toast.className = ""; }, 3000);
        }
        
        // Initial setup
        generateScreenshotInputs([]);
    </script>
</body>
</html>