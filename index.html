<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Admin Console</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; background: #1f1f1f; color: #fff; font-family: sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #282828; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        
        .menu-item { padding: 15px; cursor: pointer; color: #aaa; border-radius: 5px; margin-bottom: 5px; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #383838; color: white; }
        .badge { background: #ff4757; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: auto; }
        
        .req-card, .game-row { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid #333; }
        .req-img, .game-row img { width: 50px; height: 50px; border-radius: 10px; margin-right: 15px; object-fit: cover; }
        .btn { padding: 8px 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .btn-view { background: #3498db; color: white; }
        .btn-approve { background: #00c851; color: white; }
        .btn-reject { background: #ff4444; color: white; }
        .btn-small { margin-left:5px; font-size:12px; }
        .bg-red { background: #ff4757; color: white; }
        .bg-yellow { background: #ffa502; color: black; }

        input, textarea, select { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        label { display: block; color: #aaa; margin-bottom: 5px; font-size: 14px; }
        .file-box { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
        .preview-img { height: 60px; margin-top: 10px; display: none; object-fit: contain; margin-left: auto; margin-right: auto; }
        .two-col { display: flex; gap: 15px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #222; padding: 30px; border-radius: 15px; width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid #444; }
        .info-row { margin-bottom: 10px; font-size: 14px; color: #ccc; }
        .info-label { font-weight: bold; color: #00d4ff; }
        .download-link-text { font-size: 11px; color: #aaa; background: #111; padding: 5px; border-radius: 4px; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1f1f1f; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="background:#282828; padding:40px; border-radius:10px; text-align:center;">
            <h2>Admin Login</h2>
            <input type="password" id="adminKey" placeholder="Admin Key" style="padding:10px; width:100%; margin-bottom:10px; background:#333; border:1px solid #444; color:white;">
            <button class="btn btn-view" onclick="window.checkAdmin()">Enter</button>
        </div>
    </div>

    <div class="sidebar">
        <h2 style="color:#00A173">Nexus Admin</h2>
        <div class="menu-item active" onclick="window.showTab('publish')">Publish / Edit</div>
        <div class="menu-item" onclick="window.showTab('requests')">Requests <span id="req-count" style="background:red; padding:2px 6px; border-radius:10px; font-size:10px;">0</span></div>
        <div class="menu-item" onclick="window.showTab('live')">Live Apps</div>
    </div>

    <div class="main">
        
        <!-- PUBLISH VIEW -->
        <div id="tab-publish">
            <h1 id="form-title">Publish New App</h1>
            <div style="background: #282828; padding: 25px; border-radius: 12px;">
                <label>App Name</label><input type="text" id="name" placeholder="Name">
                <div class="two-col">
                    <div style="flex:1"><label>Type</label><select id="appType"><option>Game</option><option>App</option></select></div>
                    <div style="flex:1"><label>Category</label><select id="appCat"><option>Action</option><option>Racing</option><option>RPG</option><option>Tools</option><option>Social</option></select></div>
                </div>
                <div class="two-col">
                    <div style="flex:1"><label>Size</label><input type="text" id="appSize" placeholder="1.2 GB"></div>
                    <div style="flex:1"><label>Age</label><input type="text" id="appAge" placeholder="12+"></div>
                </div>
                <div class="two-col">
                    <div style="flex:1"><label>Pricing</label><select id="priceType" onchange="window.togglePrice()"><option value="Free">Free</option><option value="Paid">Paid</option></select></div>
                    <div style="flex:1"><label>Price</label><input type="text" id="appPrice" placeholder="Rs. 500" disabled style="opacity:0.5"></div>
                </div>
                <input type="hidden" id="appDeveloper">
                <label>Icon</label>
                <div class="file-box" onclick="document.getElementById('iconFile').click()">Click to Upload Icon<img id="iconPrev" class="preview-img"></div>
                <input type="file" id="iconFile" hidden accept="image/*" onchange="window.handleIcon(this)">
                <input type="hidden" id="iconBase64">
                <label>Download Link</label><input type="text" id="link" placeholder="URL">
                <label>Description</label><textarea id="desc" rows="3"></textarea>
                <label>Screenshots</label><div id="sc-container"></div>
                <button class="btn" style="background:#444; color:white; margin-bottom:15px;" onclick="window.addScField()">+ Screenshot</button>

                <button class="btn" id="btn-submit" onclick="window.publishApp()">PUBLISH</button>
                <button class="btn bg-red" id="btn-cancel" style="display:none; margin-top:10px;" onclick="window.resetForm()">CANCEL EDIT</button>
            </div>
        </div>

        <!-- REQUESTS VIEW -->
        <div id="tab-requests" style="display:none;">
            <h1>Pending Review</h1>
            <div id="requests-list">Loading...</div>
        </div>

        <!-- LIVE APPS VIEW -->
        <div id="tab-live" style="display:none;">
            <h1>Published Apps</h1>
            <div id="live-list">Loading...</div>
        </div>
    </div>

    <!-- REVIEW MODAL -->
    <div id="review-modal" class="modal">
        <div class="modal-content">
            <h2 id="m-title">App Name</h2>
            <div style="text-align:center; margin-bottom:20px;"><img id="m-icon" style="width:80px; height:80px; border-radius:15px; object-fit:cover;"></div>
            
            <div class="info-row"><span class="info-label">Request Type:</span> <span id="m-req-type" style="color:orange; font-weight:bold;"></span></div>
            <div class="info-row"><span class="info-label">Developer:</span> <span id="m-dev"></span></div>
            <div class="info-row"><span class="info-label">Category:</span> <span id="m-cat"></span></div>
            <div class="info-row"><span class="info-label">Price:</span> <span id="m-price"></span></div>
            <div class="info-row"><span class="info-label">Description:</span> <span id="m-desc"></span></div>
            
            <div style="margin:20px 0; border-top:1px solid #444; padding-top:10px;">
                <span class="info-label">Download Link:</span>
                <a id="m-link-text" href="#" target="_blank" class="download-link-text">...</a>
                <button class="btn" style="background:#333; color:white; width:100%; margin-top:10px;" onclick="window.openTestDownload()">Download & Check App</button>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-approve" style="flex:1" onclick="window.approveApp()">APPROVE</button>
                <button class="btn btn-reject" style="flex:1" onclick="window.rejectApp()">REJECT</button>
            </div>
            <button onclick="document.getElementById('review-modal').style.display='none'" style="background:none; border:none; color:#aaa; width:100%; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, push, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn1FBaxDwbvC28VWXAcq557uCidl-JHy0",
            authDomain: "app-store-6b5d4.firebaseapp.com",
            databaseURL: "https://app-store-6b5d4-default-rtdb.firebaseio.com",
            projectId: "app-store-6b5d4",
            storageBucket: "app-store-6b5d4.firebasestorage.app",
            messagingSenderId: "55022892860",
            appId: "1:55022892860:web:f48865da1539854bf8d039"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let pendingApps = {};
        let currentReviewId = null;
        let currentAppData = null;
        let liveAppsData = {};
        let currentEditId = null;

        window.checkAdmin = () => {
            const k = document.getElementById('adminKey').value;
            if(k === "saqib rasa mustafai") { 
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard').style.display='flex';
            } else { alert("Wrong Key!"); }
        };

        window.showTab = (t) => {
            document.getElementById('tab-publish').style.display = t === 'publish' ? 'block' : 'none';
            document.getElementById('tab-requests').style.display = t === 'requests' ? 'block' : 'none';
            document.getElementById('tab-live').style.display = t === 'live' ? 'block' : 'none';
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.target.classList.add('active');
        };

        // FORM
        const compress=(f)=>new Promise(r=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas'),s=500/i.width;c.width=500;c.height=i.height*s;c.getContext('2d').drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.7))}}});
        
        window.handleIcon=async(i)=>{if(i.files[0]){const b=await compress(i.files[0]);document.getElementById('iconBase64').value=b;document.getElementById('iconPrev').src=b;document.getElementById('iconPrev').style.display='block';}};
        window.togglePrice=()=>{const t=document.getElementById('priceType').value;const i=document.getElementById('appPrice');if(t==='Paid'){i.disabled=false;i.style.opacity=1}else{i.disabled=true;i.style.opacity=0.5;i.value=''}};
        window.addScField=()=>{const d=document.createElement('div');d.innerHTML=`<input type="file" class="sc-file" accept="image/*" onchange="window.handleSc(this)" style="margin-bottom:5px">`;document.getElementById('sc-container').appendChild(d);};
        window.handleSc=async(i)=>{if(i.files[0]){const b=await compress(i.files[0]);i.setAttribute('data-b64', b); i.style.border="1px solid #00d4ff";}};

        // --- FIXED PUBLISH BUTTON ---
        window.publishApp = () => {
            const btn = document.getElementById('btn-submit');
            btn.innerText = "Processing...";

            const data = {
                name: document.getElementById('name').value,
                type: document.getElementById('appType').value,
                category: document.getElementById('appCat').value,
                size: document.getElementById('appSize').value,
                age: document.getElementById('appAge').value,
                priceType: document.getElementById('priceType').value,
                price: document.getElementById('appPrice').value || "Free",
                logo: document.getElementById('iconBase64').value,
                download: document.getElementById('link').value,
                desc: document.getElementById('desc').value,
                developer: document.getElementById('appDeveloper').value || "Nexus Official",
                timestamp: Date.now(),
                status: "Live"
            };

            const screenshots = [];
            document.querySelectorAll('.sc-file').forEach(i => { const v=i.getAttribute('data-b64'); if(v) screenshots.push(v); });
            if(screenshots.length > 0) data.screenshots = screenshots;
            
            if(currentEditId && screenshots.length===0 && liveAppsData[currentEditId].screenshots) {
                data.screenshots = liveAppsData[currentEditId].screenshots;
            }

            if(!data.name || !data.download) { btn.innerText = "PUBLISH"; return alert("Missing fields"); }

            if(currentEditId) {
                update(ref(db, 'games/'+currentEditId), data).then(() => { alert("Updated!"); window.resetForm(); });
            } else {
                data.downloadCount = 0;
                push(ref(db, 'games'), data).then(() => { alert("Published!"); window.resetForm(); });
            }
        };

        // --- EDIT LOGIC ---
        window.editApp = (id) => {
            currentEditId = id; const app = liveAppsData[id];
            window.showTab('publish');
            document.querySelectorAll('.menu-item')[0].classList.add('active');
            
            document.getElementById('form-title').innerText = "Edit: " + app.name;
            document.getElementById('btn-submit').innerText = "UPDATE APP";
            document.getElementById('btn-cancel').style.display = "block";
            
            document.getElementById('name').value = app.name;
            document.getElementById('appType').value = app.type||'Game';
            document.getElementById('appCat').value = app.category||'Action';
            document.getElementById('appSize').value = app.size||'';
            document.getElementById('appAge').value = app.age||'';
            document.getElementById('priceType').value = app.priceType||'Free';
            document.getElementById('appPrice').value = app.price||'';
            window.togglePrice();
            
            document.getElementById('appDeveloper').value = app.developer;
            document.getElementById('link').value = app.download;
            document.getElementById('desc').value = app.desc;
            document.getElementById('iconBase64').value = app.logo;
            document.getElementById('iconPrev').src = app.logo;
            document.getElementById('iconPrev').style.display = 'block';
        };

        window.resetForm = () => {
            currentEditId = null;
            document.querySelectorAll('input, textarea').forEach(i=>i.value="");
            document.getElementById('iconPrev').style.display='none';
            document.getElementById('sc-container').innerHTML="";
            document.getElementById('form-title').innerText = "Publish New App";
            document.getElementById('btn-submit').innerText = "PUBLISH";
            document.getElementById('btn-cancel').style.display = "none";
            document.getElementById('appDeveloper').value = ""; 
        };

        // DATA LOADER
        onValue(ref(db, 'games'), snap => {
            const d = snap.val();
            liveAppsData = d || {};
            const list = document.getElementById('list-live'); list.innerHTML="";
            if(d) Object.entries(d).reverse().forEach(([k, v]) => {
                list.innerHTML += `<div class="game-row"><img src="${v.logo}"><div style="flex:1"><b>${v.name}</b><br><small>${v.developer}</small></div><button class="btn btn-small bg-yellow" onclick="window.editApp('${k}')">Edit</button><button class="btn btn-small bg-red" onclick="window.deleteLive('${k}')">Del</button></div>`;
            });
        });

        onValue(ref(db, 'pending_apps'), snap => {
            const d = snap.val();
            pendingApps = d || {};
            const list = document.getElementById('requests-list'); list.innerHTML="";
            let count = 0;
            if(d) Object.entries(d).forEach(([k, v]) => {
                // HIDE REJECTED FROM LIST
                if(v.status !== 'Rejected') {
                    count++;
                    const badge = v.requestType === "Update" ? '<span style="background:orange;color:black;padding:2px;font-size:10px;">UPDATE</span>' : '<span style="background:lime;color:black;padding:2px;font-size:10px;">NEW</span>';
                    list.innerHTML += `<div class="req-card"><img src="${v.logo}" class="req-img"><div class="req-info"><b>${v.name}</b> ${badge}<br><small>Dev: ${v.developer}</small></div><button class="btn btn-view" onclick="window.reviewReq('${k}')">Review</button></div>`;
                }
            });
            document.getElementById('req-count').innerText = count;
        });

        window.reviewReq = (id) => {
            currentReviewId = id; currentAppData = pendingApps[id];
            document.getElementById('m-title').innerText = currentAppData.name;
            document.getElementById('m-icon').src = currentAppData.logo;
            document.getElementById('m-req-type').innerText = currentAppData.requestType || "New";
            document.getElementById('m-dev').innerText = currentAppData.developer;
            document.getElementById('m-cat').innerText = currentAppData.category;
            document.getElementById('m-price').innerText = currentAppData.priceType === 'Paid' ? currentAppData.price : 'Free';
            document.getElementById('m-desc').innerText = currentAppData.desc;
            
            const linkText = document.getElementById('m-link-text');
            linkText.innerText = currentAppData.download;
            linkText.href = currentAppData.download;
            
            document.getElementById('review-modal').style.display = 'flex';
        };

        window.openTestDownload = () => window.open(currentAppData.download, '_blank');

        window.approveApp = () => {
            if(!currentReviewId) return;
            const liveData = { ...currentAppData, status: "Live" };
            delete liveData.originalId; delete liveData.requestType;
            if(!liveData.downloadCount) liveData.downloadCount = 0;

            if (currentAppData.originalId) { // Update
                update(ref(db, 'games/' + currentAppData.originalId), liveData).then(() => {
                    remove(ref(db, 'pending_apps/' + currentReviewId));
                    alert("Updated!");
                    document.getElementById('review-modal').style.display = 'none';
                });
            } else { // New
                push(ref(db, 'games'), liveData).then(() => {
                    remove(ref(db, 'pending_apps/' + currentReviewId));
                    alert("Approved!");
                    document.getElementById('review-modal').style.display = 'none';
                });
            }
        };

        window.rejectApp = () => {
            if(confirm("Reject submission?")) {
                update(ref(db, 'pending_apps/' + currentReviewId), { status: 'Rejected' }).then(() => {
                    document.getElementById('review-modal').style.display = 'none';
                    alert("Rejected");
                });
            }
        };

        window.deleteLive = (id) => { if(confirm("Delete live app?")) remove(ref(db, 'games/'+id)); };

    </script>
</body>
</html>