<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Console | Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; background: #1f1f1f; color: #fff; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1f1f1f; display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-box {
            background: #282828; padding: 40px; border-radius: 15px;
            width: 350px; text-align: center; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* DASHBOARD */
        #dashboard { display: none; width: 100%; height: 100%; }
        .sidebar { width: 250px; background: #282828; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* FORM INPUTS */
        input, textarea, select { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        label { display: block; color: #aaa; margin-bottom: 5px; font-size: 14px; }
        
        .btn { background: #00A173; color: black; border: none; padding: 12px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn:hover { background: #00c48c; }
        
        .file-box { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
        .preview-img { height: 60px; margin-top: 10px; display: none; object-fit: contain; }
        
        .two-col { display: flex; gap: 15px; }
        
        /* LIST STYLES */
        .game-row { display: flex; align-items: center; background: #282828; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; }
        .game-row img { width: 40px; height: 40px; border-radius: 8px; margin-right: 15px; }
        .btn-small { width: auto; padding: 5px 15px; font-size: 12px; border-radius: 6px; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#00A173; margin-top:0;">Admin Access</h2>
            <input type="email" id="admin-email" placeholder="Admin Email">
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn" onclick="window.adminLogin()">Login</button>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard">
        <div class="sidebar">
            <h2 style="color:#00A173">Nexus Console</h2>
            <p>Admin Panel</p>
            <div style="margin-top:auto">
                <button class="btn" style="background:#ff4757; color:white;" onclick="window.adminLogout()">Logout</button>
            </div>
        </div>

        <div class="main">
            <h1>Create New Release</h1>
            
            <div style="background: #282828; padding: 20px; border-radius: 10px; margin-bottom:30px;">
                <label>App Name</label>
                <input type="text" id="name" placeholder="e.g. Minecraft">

                <div class="two-col">
                    <div style="flex:1">
                        <label>Type</label>
                        <select id="appType"><option value="Game">Game</option><option value="App">App</option></select>
                    </div>
                    <div style="flex:1">
                        <label>Category</label>
                        <select id="appCategory">
                            <option value="Action">Action</option><option value="Racing">Racing</option>
                            <option value="RPG">RPG</option><option value="Simulation">Simulation</option>
                            <option value="Social">Social</option><option value="Tools">Tools</option>
                        </select>
                    </div>
                </div>

                <!-- NEW: RATING + PRICING ROW -->
                <div class="two-col">
                    <div style="flex:1">
                        <label>Pricing</label>
                        <select id="priceType" onchange="window.togglePriceInput()">
                            <option value="Free">Free</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Price (if Paid)</label>
                        <input type="text" id="appPrice" placeholder="e.g. $4.99" disabled style="opacity:0.5;">
                    </div>
                </div>

                <!-- STATS ROW -->
                <div class="two-col">
                    <div style="flex:1">
                        <label>Size</label>
                        <input type="text" id="appSize" placeholder="e.g. 1.2 GB">
                    </div>
                    <div style="flex:1">
                        <label>Age Rating</label>
                        <input type="text" id="appAge" placeholder="e.g. 12+">
                    </div>
                    <div style="flex:1">
                        <label>Star Rating (1-5)</label>
                        <input type="text" id="appRating" placeholder="e.g. 4.5">
                    </div>
                </div>

                <label>App Icon</label>
                <div class="file-box" onclick="document.getElementById('iconFile').click()">
                    Click to Upload Icon
                    <img id="iconPrev" class="preview-img">
                </div>
                <input type="file" id="iconFile" hidden accept="image/*" onchange="window.handleIcon(this)">
                <input type="hidden" id="iconBase64">

                <label>Download Link</label>
                <input type="text" id="link" placeholder="Direct Download URL">

                <label>Description</label>
                <textarea id="desc" rows="3"></textarea>

                <label>Screenshots</label>
                <div id="sc-container"></div>
                <button class="btn" style="background:#444; color:white; margin-bottom:15px;" onclick="window.addScField()">+ Screenshot</button>
                
                <button class="btn" id="publishBtn" onclick="window.publish()">PUBLISH APP</button>
                <button class="btn" id="cancelBtn" style="background:#333; margin-top:10px; display:none;" onclick="window.resetForm()">CANCEL EDIT</button>
            </div>

            <h2>Published Apps</h2>
            <div id="app-list">Loading...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn1FBaxDwbvC28VWXAcq557uCidl-JHy0",
            authDomain: "app-store-6b5d4.firebaseapp.com",
            databaseURL: "https://app-store-6b5d4-default-rtdb.firebaseio.com",
            projectId: "app-store-6b5d4",
            storageBucket: "app-store-6b5d4.firebasestorage.app",
            messagingSenderId: "55022892860",
            appId: "1:55022892860:web:f48865da1539854bf8d039"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentEditId = null;
        let allApps = {};

        // AUTH
        window.adminLogin = () => {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
        };
        window.adminLogout = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('dashboard').style.display='flex';
                loadApps();
            } else {
                document.getElementById('login-screen').style.display='flex';
                document.getElementById('dashboard').style.display='none';
            }
        });

        // PRICING TOGGLE
        window.togglePriceInput = () => {
            const type = document.getElementById('priceType').value;
            const field = document.getElementById('appPrice');
            if(type === 'Paid') {
                field.disabled = false;
                field.style.opacity = "1";
            } else {
                field.disabled = true;
                field.style.opacity = "0.5";
                field.value = "";
            }
        };

        // IMAGE HANDLING
        const compress = (f) => new Promise(r => { const rd=new FileReader(); rd.readAsDataURL(f); rd.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'),s=500/i.width; c.width=500; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.8)); } } });

        window.handleIcon = async (inp) => { if(inp.files[0]) { const b64 = await compress(inp.files[0]); document.getElementById('iconBase64').value = b64; document.getElementById('iconPrev').src = b64; document.getElementById('iconPrev').style.display='block'; } };
        window.addScField = () => { const d=document.createElement('div'); d.innerHTML=`<input type="file" class="sc-file" accept="image/*" style="width:80%" onchange="window.handleSc(this)">`; document.getElementById('sc-container').appendChild(d); };
        window.handleSc = async (inp) => { if(inp.files[0]) { const b64 = await compress(inp.files[0]); inp.setAttribute('data-b64', b64); inp.style.border="1px solid #00A173"; } };

        // PUBLISH / UPDATE
        window.publish = () => {
            const data = {
                name: document.getElementById('name').value,
                logo: document.getElementById('iconBase64').value,
                download: document.getElementById('link').value,
                desc: document.getElementById('desc').value,
                type: document.getElementById('appType').value,
                category: document.getElementById('appCategory').value,
                priceType: document.getElementById('priceType').value,
                price: document.getElementById('appPrice').value || "Free",
                size: document.getElementById('appSize').value || "N/A",
                age: document.getElementById('appAge').value || "3+",
                rating: document.getElementById('appRating').value || "4.5", // Added Rating
                timestamp: Date.now()
            };

            const screenshots = [];
            document.querySelectorAll('.sc-file').forEach(i => { const v=i.getAttribute('data-b64'); if(v) screenshots.push(v); });
            
            if(screenshots.length > 0) data.screenshots = screenshots;
            else if(currentEditId && allApps[currentEditId].screenshots) data.screenshots = allApps[currentEditId].screenshots;

            if(!data.name || !data.download) return alert("Missing Fields");

            if(currentEditId) {
                update(ref(db, 'games/'+currentEditId), data).then(() => { alert("Updated!"); window.resetForm(); });
            } else {
                data.downloadCount = 0;
                push(ref(db, 'games'), data).then(() => { alert("Published!"); window.resetForm(); });
            }
        };

        // EDIT & DELETE
        window.editApp = (id) => {
            currentEditId = id;
            const d = allApps[id];
            
            document.getElementById('name').value = d.name;
            document.getElementById('link').value = d.download;
            document.getElementById('desc').value = d.desc;
            document.getElementById('appType').value = d.type || "Game";
            document.getElementById('appCategory').value = d.category || "Action";
            document.getElementById('priceType').value = d.priceType || "Free";
            document.getElementById('appPrice').value = d.price || "";
            document.getElementById('appSize').value = d.size || "";
            document.getElementById('appAge').value = d.age || "";
            document.getElementById('appRating').value = d.rating || ""; // Set Rating
            
            document.getElementById('iconBase64').value = d.logo;
            document.getElementById('iconPrev').src = d.logo;
            document.getElementById('iconPrev').style.display = 'block';
            window.togglePriceInput();

            document.getElementById('publishBtn').innerText = "UPDATE APP";
            document.getElementById('cancelBtn').style.display = "block";
            document.querySelector('.main').scrollTop = 0;
        };

        window.resetForm = () => {
            currentEditId = null;
            document.querySelectorAll('input, textarea').forEach(i => i.value="");
            document.getElementById('iconPrev').style.display='none';
            document.getElementById('publishBtn').innerText = "PUBLISH APP";
            document.getElementById('cancelBtn').style.display = "none";
        };

        window.deleteApp = (id) => { if(confirm("Delete?")) remove(ref(db, 'games/'+id)); };

        function loadApps() {
            onValue(ref(db, 'games'), snap => {
                const d = snap.val();
                const list = document.getElementById('app-list');
                list.innerHTML = "";
                allApps = d || {};
                if(d) {
                    Object.entries(d).forEach(([k, v]) => {
                        list.innerHTML += `
                            <div class="game-row">
                                <img src="${v.logo}">
                                <div style="flex:1"><b>${v.name}</b><br><small>${v.priceType} | ${v.rating}â˜…</small></div>
                                <div>
                                    <button class="btn btn-small" style="background:#ffa502;color:black" onclick="window.editApp('${k}')">Edit</button>
                                    <button class="btn btn-small" style="background:#ff4757" onclick="window.deleteApp('${k}')">Del</button>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }
    </script>
</body>
</html>